---
title: "E. coli resistance patterns from Community Resistance in Athens Project"
subtitle: ""
author: Andreas Handel
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: article
output:
  bookdown::word_document2: 
    toc: false
    number_sections: true
  bookdown::html_document2: 
    toc: false
bibliography: ../references.bib
csl: ../apa.csl
---

The structure below is a possible setup for a data analysis project (including the course project). For a manuscript, adjust as needed.


# Summary/Abstract
_Write a summary of your project._
For this project, I will analyze the data I have collected from my time as a lab technician in the Community Resistance in Athens Project on the antibiotic resistance carriage rates of _E. coli_ from Athens residents and see if there is a relationship between resistance and diet of the participants in the study.

# Introduction 

## General Background Information
_Provide enough background on your topic that others can understand the why and how of your analysis_ 

As microbes are evolving to resist the drugs we commonly use to treat infections, antibiotic resistance is becoming a rapidly growing health threat worldwide. The Community Resistance in Athens Project seeks to better understand carriage rates of multi-drug resistant _E. coli_ such as extended spectrum beta lactamase-producing Enterobacteriaceae and carbapenem resistant Enterobacteriaceae. In addition, the CRAP project is gathering data on the resistance patterns of _E. coli_ from individuals in Athens. The data I will be using is a combination of microbiological data that I have collected and the epidemiological data from the survey. The microbiological data quantifies the resistance patterns of _E. coli_ from individuals to different antibiotics. The survey queries the study participants on a variety of personal and lifestyle questions, including drinking water sources, diet, economic information, etc.

## Description of data and data source
_Describe what the data is, what it contains, where it is from, etc. Eventually this might be part of a methods section._  

The data from this project comes from a collaborative effort between the CDC, UGA's Genetics, Environmental Health, Microbiology, and Epidemiology departments, the USDA, and the UGA Clinical and Translational Research Unit. From participants, we collect a stool sample, take a small diluted aliquot, and grow its _E. coli_ on on selective agar. I further purify these isolates, then test 48 or less from each sample, provided _E. coli_ grows, onto different agar plates containing either ampicillin, tetracycline, ceftriaxone, ciprofloxacin, or trimethoprim. As lab technician for the CRAP project, I have recorded the data on the _E. coli_ resistance patterns to various antibiotics myself. The data on food consumption, animal contact, and the other epidemiological data comes from a survey each of the participants must take as a part of the study. This survey is IRB approved and survey and sample collection are organized by the Clinical and Translational Research Unit at the University of Georgia. 
We have data from approximately 300 individuals at this point (with the ultimate goal being 550), and the resistance patterns of approximately 13,000 _E. coli_ isolates. We have already made figures for basic questions concerning this data, like what proportions of the study population that show resistance to each antibiotic type and demographics, so I would like to focus on environmental and behavioral factors.

## Questions/Hypotheses to be addressed
_State the research questions you plan to answer with this analysis._   
For this project, we have already observed the general resistance patterns and carriage rates of _E. coli_, so I would like to see if there is a relationship between the resistance patterns and the diet of the individuals. Some researchers presume that commensal gut bacteria act as reservoirs for genes with antibiotic resistance, which could lead to horizontal gene transfer and possibly the development of dangerous multi-drug resistant bacteria (Mathur, et. al). There is abundant research on antibiotic resistance exposure in healthcare settings, and there is a gap in knowledge on everyday exposures, like food. There is evidence that bacteria from fermented dairy and meat commonly carry AR gene (Mathur, et.al). In addition, according to the CDC, raw fruits and vegetables may be contaminated by soil and water (CDC 2020). 
With respect to this information, I have a few questions.   

* Do individuals who eat meat more than half of the days in the last week have higher resistance than do those who do not?

* Do individuals who eat dairy more than half of the days in the last week have higher resistance than do those who do not?

* Do individuals who eat raw fruits or vegetables more than half of the days in the last week have higher resistance than do those who do not?  

In addition to these questions, I am interested in the following, if I have time:

* Are resistance patterns influenced temporally?

* Are individuals with exposure to animals (pets, cattle, etc.) have higher resistance patterns than those who do not?

* In there any relationship between resistance of _E. coli_ in an individual and the age of the participant?


# Methods and Results

_In most research papers, results and methods are separate. You can combine them here if you find it easier. You are also welcome to structure things such that those are separate sections._


## Data aquisition
_As applicable, explain where and how you got the data. If you directly import the data from an online source, you can combine this section with the next._
This is partly explained in the "Description of data and data source" section. In addition, the resistance patterns will be in a single csv file that I create from an excel sheet. The information on food consumption has been cleaned by another member of the CRAP team and he will share the information with my promptly. It will also be in a csv file. 

## Data import and cleaning
_Write code that reads in the file and cleans it so it's ready for analysis. Since this will be fairly long code for most datasets, it might be a good idea to have it in one or several R scripts. If that is the case, explain here briefly what kind of cleaning/processing you do, and provide more details and well documented code somewhere (e.g. as supplement in a paper). All materials, including files that contain code, should be commented well so everyone can follow along._

```{r}

#load needed packages. make sure they are installed.
#library(readxl) #for loading Excel files. My data is a CSV.
library(dplyr) #for data processing
library(here) #to set paths
library(lubridate) #for dates
library(tidyr) #for cleaning


#path to data
#note the use of the here() package and not absolute paths
data_location <- here::here("data","raw_data","ARP_raw.csv")

#load data. 
#note that for functions that come from specific packages (instead of base R)
# I often specify both package and function like so
#package::function() that's not required one could just call the function
#specifying the package makes it clearer where the function "lives",
#but it adds typing. You can do it either way.

rawdata <- read.csv(data_location)

#take a look at the data
dplyr::glimpse(rawdata)


#Next, I'll clean up the date column. Below, I set each column into the
#date the stool sample is produced and the time the stool sample was produced.
#I am also making sure the columns are read as dates and times as opposed
#to characters.
#For this, I will use the lubridate package.
cleandata <- rawdata %>% separate(recorded_date, into = c(
  "date_produced","time_produced"), sep = " ")
cleandata$date_produced <- mdy(cleandata$date_produced)
cleandata$time_produced <- hm(cleandata$time_produced)


#Looking at the column "pets," I can see that there is an excess of words for
#the "no" category, so I want to simplify that as "No".
#I'd also like to make an additional column of "Yes" pets and "No".

cleandata <- mutate(cleandata, has_pets = ifelse(grepl(
  "I do not live with any companion animals", pets), "No", "Yes"))

#Later, I will move this column to the right of the "pets" column (currently 11).

#I want to see all unique values in the pets column.
unique(cleandata$pets)
#After looking at this, I want to create a column that indicates if a
#person has a dog or a cat.

cleandata <- mutate(cleandata, cat_andor_dog =ifelse(grepl(
  "Cats|Dogs", pets), "Yes",
  "No"))

#Similarly to the animal data, I want to make a column for medical exposure that
#is only the yes and no of exposure to healthcare settings. Then I want to move
#this column to column 8.

cleandata <- mutate(cleandata, healthcare_exposure_yn =ifelse(grepl(
  "No, I do not have regular exposure to healthcare environments", healthcare_exposure), "No",
  "Yes"))


#Now I want to do some rearranging.
#Now I want to rearrange the columns so pets is in the 12th column and 
#cat_andor_dog is the 13th.
#I want to move the y/n exposure to healthcare environment regularly to
#beside healthcare_exposure

cleandata <- cleandata[,c(1:8, 46, 9:12, 44,45, 13:43)]

#I'm also removing the column half_total_isolates because I see no use for it.
#Delete time sample produced, age column (because there is already a numeric age column).

cleandata <- cleandata[-c(36, 3, 28)]


#Another thing I am considering is removing any columns that have "No" in the 
#ecoli_cultured column because we cannot study the antibiotic patterns of
#the samples that do not produce E. coli. I will revisit this idea later because
#it may be dangerous to delete large chunks of data like that.


```

## Exploratory analysis


```{r}

#load needed packages. make sure they are installed.
library(ggplot2) #for plotting
library(broom) #for cleaning up output from lm()
library(here) #for data loading/saving



library(dplyr) #for data wrangling
library(reshape) #for reshaping and melting data

#path to data
#note the use of the here() package and not absolute paths
data_location <- here::here("data","processed_data","processeddata.rds")

#load data. 
mydata <- readRDS(data_location)

######################################
#Data exploration/description
######################################
#I'm using basic R commands here.
#Lots of good packages exist to do more.
#For instance check out the tableone or skimr packages

#summarize data 
mysummary = summary(mydata)

#look at summary
print(mysummary)


#Let's look at demographics for the study.
mydata %>% ggplot(aes(x = race)) +
  geom_bar()
#^The race data shows that a majority of the participants are white.
mydata %>% ggplot(aes(x = biological_sex)) +
  geom_bar()
#^This biological sex data shows that, when observing males and females,
#the participant group is primarily female.
mydata %>% ggplot(aes(x = numeric_age)) +
  geom_bar()
#^This age data shows that the age of the participants skews
#strongly left/young.
```

I want to take a look at one of the main outcomes/relationships- that between food and one of the antibiotics.
```{r}

#Let's look at the food data. I want to make a separate data set of
#food information so I can make a melted data set.
#The figure at the end shows the number of participants that ate
#a typ

fooddata <- mydata[,c(1,20:24)] %>% 
  melt(id=c("fake_id")) %>%
  subset(select=c("variable", "value"))
fooddata$value <- as.character(fooddata$value)
fooddata <- fooddata %>% mutate(value, count = 1) %>%
  group_by(variable, value) %>%
  summarise(num_participants = sum(count))
fooddata$value <- as.numeric(fooddata$value)
  
  
fooddata_plot <- fooddata %>% ggplot(aes(x=value, y = num_participants
                        , fill = variable)) +
  geom_bar(position="dodge", stat="identity") +
  xlab("Number days a food type was consumed in last week")
fooddata_plot

#On another note, let's compare a participant's tetracycline resistance
#with its ampicillin resistance. This will be the proportion of E.coli
#isolates.

abs_pattern <- mydata %>% subset(select=c(28:33)) %>%
  mutate(amp_proportion_resistant = amp_resistant_isolates / total_isolates) %>%
  mutate(ceft_proportion_resistant = ceft_resistant_isolates / total_isolates) %>%
  mutate(cipro_proportion_resistant = cipro_resistant_isolates / total_isolates) %>%
  mutate(tetra_proportion_resistant = tetra_resistant_isolates / total_isolates) %>%
  mutate(trimet_proportion_resistant = trimet_resistant_isolates / total_isolates)

amp_tet_plot <- abs_pattern %>% ggplot(
  aes(x=amp_proportion_resistant, y = tetra_proportion_resistant)) +
  geom_point()

#Wow, there kind of seem to be patterns here, but also in other ways there
#is no correlation. I had a thought that we could remove any zero values, but 
#that is a really bad idea because it is straight up removing data to make 
#a pattern, so I will not do that. You can kind of see a diagonal line, but
#I do not think we can say anything because of the excessive outliers.


#I want to see if ampicillin resistance and number of days an individual ate
#fruit that week are correlated

amp_rawproduce <- mydata %>% subset(select = c(1,24,28, 29)) %>%
  mutate(amp_prop_res = amp_resistant_isolates / total_isolates)
amp_rawproduce$eat_raw_fruits_or_vegetables_past_week <- as.character(amp_rawproduce$eat_raw_fruits_or_vegetables_past_week)

amp_produce_plot <- amp_rawproduce %>% ggplot(aes(eat_raw_fruits_or_vegetables_past_week, amp_prop_res)) + 
  geom_point()
#I know that number of days fruit was eaten is categorical and not numeric,
#but at this time I do not have a better way to approach this.


#None of this data is ready to put in the manuscript.
#save data frame table to file for later use in manuscript
#summarytable_file = here("results", "summarytable.rds")
#saveRDS(summary_df, file = summarytable_file)

######################################
#Data fitting/statistical analysis
######################################

# fit linear model
amptetfit <- lm(amp_proportion_resistant ~ tetra_proportion_resistant, abs_pattern)  

# place results from fit into a data frame with the tidy function
amptettable <- broom::tidy(amptetfit)

#look at fit results
print(amptettable)

# save ampicillin tetracycline fit results table  
amptettable_file = here("results", "amptettable.rds")
saveRDS(amptettable, file = amptettable_file)

#save ampicillin tetracycline figure results
amp_tet_plot_figure = here("results", "amp_tet_plot")
saveRDS(amp_tet_plot, file = amp_tet_plot_figure)


#save ampicillin-raw produce figure  
amp_produce_plot_figure = here("results", "amp_produce_plot")
saveRDS(amp_produce_plot, file = amp_produce_plot_figure)

```


## Full analysis

_Use one or several suitable statistical/machine learning methods to analyze your data and to produce meaningful figures, tables, etc. This might again be code that is best placed in one or several separate R scripts that need to be well documented. You want the code to produce figures and data ready for display as tables, and save those. Then you load them here._

Example table \@ref(tab:resulttable) shows a table summarizing a linear model fit.

```{r resulttable,  echo=FALSE}
resulttable=readRDS("../../results/resulttable.rds")
knitr::kable(resulttable, caption = 'Linear model fit table.')
```


# Discussion

## Summary and Interpretation
_Summarize what you did, what you found and what it means._

## Strengths and Limitations
_Discuss what you perceive as strengths and limitations of your analysis._

## Conclusions
_What are the main take-home messages?_

_Include citations in your Rmd file using bibtex, the list of references will automatically be placed at the end_

This paper [@Leek2015a] discusses types of analyses. 

Note that this cited reference will show up at the end of the document, the reference formatting is determined by the CSL file specified in the YAML header. Many more style files for almost any journal [are available](https://www.zotero.org/styles). You also specify the location of your bibtex reference file in the YAML. You can call your reference file anything you like, I just used the generic word `references.bib` but giving it a more descriptive name is probably better.


# References
(I will put these links in proper format soon.)

* https://www.cambridge.org/core/journals/epidemiology-and-infection/article/risk-factors-for-antibioticresistant-e-coli-in-children-in-a-rural-area/D3A8BA423024A18D592BAA70719608A0

* https://www.sciencedirect.com/science/article/pii/S1473309918302962?casa_token=j_ZSlMulgkcAAAAA:dUmvDkbjCNWA2ELFH1tBujfCqNQVtCEWm9aGJOaYCzZ8aQDgWEOie1US-SLNsw3AqNA9xbW2nQ

* https://www.sciencedirect.com/science/article/pii/S1473309918302962?casa_token=j_ZSlMulgkcAAAAA:dUmvDkbjCNWA2ELFH1tBujfCqNQVtCEWm9aGJOaYCzZ8aQDgWEOie1US-SLNsw3AqNA9xbW2nQ

* https://www.nature.com/articles/39767

* https://www.sciencedirect.com/science/article/pii/S0168160505002618
* https://www.cdc.gov/foodsafety/challenges/antibiotic-resistance.html


